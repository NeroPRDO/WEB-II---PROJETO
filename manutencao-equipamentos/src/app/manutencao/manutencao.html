<div class="manutencao-wrapper">
  <!-- DETALHES DA SOLICITAÇÃO / CLIENTE -->
  <section class="card detalhes" *ngIf="solicitacao">
    <header class="header">
      <img src="/assets/img/laptop-broken.png" alt="equipamento" class="equip-img" />
      <div class="title">
        <h1>Manutenção de Equipamentos</h1>
      </div>
    </header>

    <hr />

    <div class="info">
      <h3>Solicitação #{{ solicitacao.id }}</h3>
      <p><strong>Problema:</strong> {{ solicitacao.problema }}</p>
      <p>
        <strong>Equipamento:</strong>
        {{ solicitacao.equipamento.tipo }} —
        {{ solicitacao.equipamento.marca }} {{ solicitacao.equipamento.modelo }}
        (S/N: {{ solicitacao.equipamento.serie }})
      </p>
      <p><strong>Aberta em:</strong> {{ formatDate(solicitacao.dataAbertura) }}</p>
      <p><strong>Status:</strong> <span class="status">{{ solicitacao.status }}</span></p>

      <hr />

      <h4>Dados do Cliente</h4>
      <p><strong>Nome:</strong> {{ solicitacao.cliente.nome }}</p>
      <p><strong>Contato:</strong> {{ solicitacao.cliente.contato }} — {{ solicitacao.cliente.telefone }}</p>
      <p><strong>Endereço:</strong> {{ solicitacao.cliente.endereco }}</p>

      <hr />

      <div *ngIf="solicitacao.manutencoes?.length">
        <h4>Histórico de Manutenções</h4>
        <ul class="historico">
          <li *ngFor="let m of solicitacao.manutencoes">
            <div class="hist-meta">
              <strong>{{ formatDate(m.dataHora) }}</strong> — {{ m.funcionario.nome }}
            </div>
            <div class="hist-desc">{{ m.descricao }}</div>
            <div class="hist-orient"><em>Orientações: {{ m.orientacoes }}</em></div>
          </li>
        </ul>
      </div>
    </div>
  </section>

<aside class="card acoes">
  <h2>Ações do Funcionário</h2>

  <div class="btns">
    <button
      class="primary"
      [class.active]="modo === 'efetuar'"
      (click)="setModo('efetuar')">
      Efetuar Manutenção
    </button>

    <button
      class="sec"
      [class.active]="modo === 'redirecionar'"
      (click)="setModo('redirecionar')">
      Redirecionar
    </button>

    <button
      class="sec"
      [class.active]="modo === 'finalizar'"
      (click)="setModo('finalizar')">
      Finalizar
    </button>
  </div>

  <!-- FORMULÁRIO: EFETUAR -->
  <form *ngIf="modo === 'efetuar'" (ngSubmit)="salvarManutencao()" class="form-manutencao">
    <label for="descricao">Descrição da Manutenção <span class="req">*</span></label>
    <textarea id="descricao" name="descricao" [(ngModel)]="descricao" required></textarea>

    <label for="orientacoes">Orientações para o Cliente <span class="req">*</span></label>
    <textarea id="orientacoes" name="orientacoes" [(ngModel)]="orientacoes" required></textarea>

    <div class="meta-info">
      <p><strong>Funcionário:</strong> {{ funcionario.nome }}</p>
      <p><strong>Data/Hora atual:</strong> {{ formatDate() }}</p>
    </div>

    <div class="form-actions">
      <button type="submit" class="primary">Salvar Manutenção</button>
      <button type="button" class="sec" (click)="cancelar()">Cancelar</button>
    </div>

    <p class="error" *ngIf="error">{{ error }}</p>
  </form>

  <!-- FORMULÁRIO: REDIRECIONAR -->
  <form *ngIf="modo === 'redirecionar'" (ngSubmit)="redirecionar()" class="form-manutencao">
    <label for="destino">Redirecionar para</label>
    <select id="destino"
            name="destino"
            class="form-select"
            [(ngModel)]="funcionarioDestino"
            required>
      <option value="" disabled selected>Selecione um funcionário</option>
      <option *ngFor="let f of funcionarios"
              [value]="f"
              [disabled]="f === solicitacao?.funcionarioOrigem">
        {{ f }} <span *ngIf="f === solicitacao?.funcionarioOrigem">(origem)</span>
      </option>
    </select>

    <div class="meta-info">
      <p><strong>Origem:</strong> {{ solicitacao?.funcionarioOrigem }}</p>
      <p *ngIf="funcionarioDestino"><strong>Destino:</strong> {{ funcionarioDestino }}</p>
    </div>

    <div class="form-actions">
      <button type="submit" class="primary">Confirmar Redirecionamento</button>
      <button type="button" class="sec" (click)="cancelar()">Cancelar</button>
    </div>

    <p class="error" *ngIf="error">{{ error }}</p>
  </form>

  <!-- FINALIZAR -->
  <div *ngIf="modo === 'finalizar'">
    <p><strong>Status atual:</strong> {{ solicitacao?.status }}</p>
    <p class="hist-orient">Ao confirmar, a solicitação será marcada como FINALIZADA.</p>

    <div class="form-actions">
      <button type="button" class="primary" (click)="finalizar()">Confirmar Finalização</button>
      <button type="button" class="sec" (click)="cancelar()">Cancelar</button>
    </div>
  </div>
</aside>
