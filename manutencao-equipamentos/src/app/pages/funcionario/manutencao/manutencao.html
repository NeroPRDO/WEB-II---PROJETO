<app-nav></app-nav>

<div class="container mt-4 mb-5">
  
  @if (!solicitacao) {
    <div class="text-center mt-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Carregando detalhes da solicitação...</p>
    </div>
  } 
  
  @else {
    
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h4 text-secondary">Gerenciar Solicitação #{{ solicitacao.id }}</h2>
      <button class="btn btn-outline-secondary btn-sm" routerLink="/func/painel">
        <i class="bi bi-arrow-left"></i> Voltar ao Painel
      </button>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-light fw-bold">
        <i class="bi bi-info-circle"></i> Dados do Chamado
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6 border-end">
            <h6 class="text-primary">Cliente</h6>
            <p class="mb-1"><strong>Nome:</strong> {{ solicitacao.usuario.nome }}</p>
            <p class="mb-1"><strong>Email:</strong> {{ solicitacao.usuario.email }}</p>
            <p class="mb-0"><strong>Data Abertura:</strong> {{ solicitacao.dataHora | date:'dd/MM/yyyy HH:mm' }}</p>
          </div>
          
          <div class="col-md-6">
            <h6 class="text-primary">Equipamento</h6>
            <p class="mb-1"><strong>Item:</strong> {{ solicitacao.descricaoEquipamentos || 'Não informado' }}</p>
            <p class="mb-1"><strong>Defeito:</strong> {{ solicitacao.descricao }}</p>
            <p class="mb-0">
              <strong>Estado Atual:</strong> 
              <span class="badge bg-warning text-dark">{{ solicitacao.estadoChamado }}</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-pills nav-fill mb-3 gap-2">
      
      @if (solicitacao.estadoChamado === 'APROVADA') {
        <li class="nav-item">
          <a class="nav-link cursor-pointer" 
             [class.active]="modo === 'INICIAR'" 
             (click)="modo = 'INICIAR'">
             <i class="bi bi-play-circle"></i> Iniciar
          </a>
        </li>
      }
      
      @if (solicitacao.estadoChamado === 'EM_ANDAMENTO' || solicitacao.estadoChamado === 'REDIRECIONADA') {
        <li class="nav-item">
          <a class="nav-link cursor-pointer" 
             [class.active]="modo === 'MANUTENCAO'" 
             (click)="modo = 'MANUTENCAO'">
             <i class="bi bi-tools"></i> Relatório Técnico
          </a>
        </li>
      }
      
      @if (solicitacao.estadoChamado === 'EM_ANDAMENTO' || solicitacao.estadoChamado === 'REDIRECIONADA') {
        <li class="nav-item">
          <a class="nav-link cursor-pointer" 
             [class.active]="modo === 'REDIRECIONAR'" 
             (click)="modo = 'REDIRECIONAR'">
             <i class="bi bi-arrow-right-circle"></i> Redirecionar
          </a>
        </li>
      }
    </ul>

    @if (modo === 'INICIAR') {
      <div class="card border-success shadow-sm animate-fade-in">
        <div class="card-body text-center py-5">
          <div class="mb-3 text-success">
            <i class="bi bi-play-circle-fill" style="font-size: 3rem;"></i>
          </div>
          <h4 class="card-title text-success">Iniciar Manutenção</h4>
          <p class="card-text text-muted w-75 mx-auto">
            Ao clicar abaixo, você assume a responsabilidade por este chamado e o cronômetro será iniciado.
          </p>
          <hr class="w-50 mx-auto my-4">
          <button class="btn btn-success btn-lg px-5" (click)="iniciarTrabalho()">
            <i class="bi bi-play-fill"></i> Confirmar Início
          </button>
        </div>
      </div>
    }

    @if (modo === 'MANUTENCAO') {
      <div class="card border-primary shadow-sm animate-fade-in">
        <div class="card-body">
          <h5 class="card-title text-primary mb-3">Relatório de Serviço</h5>
          
          <form [formGroup]="manutencaoForm" (ngSubmit)="salvarManutencao()">
            
            <div class="mb-3">
              <label class="form-label fw-bold">Descrição do Serviço Realizado:</label>
              <textarea 
                class="form-control" 
                rows="5" 
                formControlName="descricaoManutencao"
                placeholder="Descreva os reparos, peças trocadas e testes efetuados..."
                [class.is-invalid]="manutencaoForm.get('descricaoManutencao')?.invalid && manutencaoForm.get('descricaoManutencao')?.touched"
              ></textarea>
              <div class="invalid-feedback">
                A descrição é obrigatória (mínimo 5 caracteres).
              </div>
            </div>

            <div class="mb-4">
              <label class="form-label fw-bold">Orientações ao Cliente:</label>
              <textarea 
                class="form-control" 
                rows="3" 
                formControlName="orientacoesCliente"
                placeholder="Ex: Evitar umidade, realizar limpeza mensal..."
                [class.is-invalid]="manutencaoForm.get('orientacoesCliente')?.invalid && manutencaoForm.get('orientacoesCliente')?.touched"
              ></textarea>
              <div class="invalid-feedback">
                As orientações são obrigatórias.
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-2 fw-bold" [disabled]="manutencaoForm.invalid">
              <i class="bi bi-check-lg"></i> Salvar e Finalizar
            </button>
          </form>
        </div>
      </div>
    }

    @if (modo === 'REDIRECIONAR') {
      <div class="card border-warning shadow-sm animate-fade-in">
        <div class="card-body">
          <h5 class="card-title text-warning-emphasis mb-3">Redirecionar Chamado</h5>
          <div class="alert alert-warning py-2 mb-3">
            <small><i class="bi bi-exclamation-triangle"></i> O chamado sairá da sua lista de pendências.</small>
          </div>

          <form [formGroup]="redirecionarForm" (ngSubmit)="salvarRedirecionamento()">
            <div class="mb-4">
              <label class="form-label fw-bold">Técnico Destino:</label>
              <select 
                class="form-select form-select-lg" 
                formControlName="funcionarioDestino"
                [class.is-invalid]="redirecionarForm.get('funcionarioDestino')?.invalid && redirecionarForm.get('funcionarioDestino')?.touched"
              >
                <option value="" disabled selected>Selecione...</option>
                @for (func of funcionarios; track func.id) {
                  <option [value]="func.id">{{ func.nome }}</option>
                }
              </select>
              <div class="invalid-feedback">
                Selecione um técnico.
              </div>
            </div>

            <button type="submit" class="btn btn-warning w-100 py-2 fw-bold" [disabled]="redirecionarForm.invalid">
              <i class="bi bi-send"></i> Confirmar Redirecionamento
            </button>
          </form>
        </div>
      </div>
    }

    @if (modo === null) {
      <div class="card border-secondary shadow-sm animate-fade-in mt-3">
        <div class="card-body text-center py-5">
          
          @if (solicitacao.estadoChamado === 'ABERTO') {
            <div class="mb-3 text-primary"><i class="bi bi-hourglass-split" style="font-size: 3rem;"></i></div>
            <h4 class="text-primary">Aguardando Orçamento</h4>
            <p class="text-muted">É necessário realizar o orçamento antes de iniciar a manutenção.</p>
            }
          
          @else if (solicitacao.estadoChamado === 'ORCADO') {
            <div class="mb-3 text-warning"><i class="bi bi-currency-dollar" style="font-size: 3rem;"></i></div>
            <h4 class="text-warning">Aguardando Aprovação</h4>
            <p class="text-muted">O orçamento foi enviado. Aguarde a resposta do cliente.</p>
          }
          
          @else if (solicitacao.estadoChamado === 'FINALIZADA' || solicitacao.estadoChamado === 'ARRUMADA') {
            <div class="mb-3 text-success"><i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i></div>
            <h4 class="text-success">Solicitação Concluída</h4>
            <p class="text-muted">O processo de manutenção foi finalizado.</p>
          }
          
          @else {
            <div class="mb-3 text-secondary"><i class="bi bi-info-circle" style="font-size: 3rem;"></i></div>
            <h4>Status: {{ solicitacao.estadoChamado }}</h4>
            <p class="text-muted">Nenhuma ação de manutenção disponível para este estado.</p>
          }

        </div>
      </div>
    }

  }
</div>